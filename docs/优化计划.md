# UPnPCast 项目优化计划

## 项目现状

UPnPCast 是一个 DLNA 投屏库项目，主要结构包括：
- 主库模块（app）：作为对外 API
- 演示应用（app-demo）：用于测试功能

**重要说明：该项目尚未对外发布，处于内部开发阶段。** 这意味着我们有完全的自由度进行重构，不需要考虑向后兼容性问题。

目前项目存在的问题：
- 过度工程化，使用了大型项目的架构模式
- 多层抽象和委托模式导致代码复杂度高
- 构建系统配置过于复杂
- 测试框架混用且配置繁琐
- 错误处理机制复杂

## 优化目标

1. 减少代码复杂度，提高可维护性
2. 简化构建系统
3. 统一测试框架
4. 提供更直接的 API 调用方式
5. 减少冗余代码
6. 缩短编译时间，减小包体积

## 详细优化措施

### 1. 简化构建系统

#### 1.1 版本目录（Version Catalog）简化
- 移除 `gradle/libs.versions.toml` 文件
- 直接在各模块的 build.gradle.kts 中声明依赖版本

#### 1.2 减少插件使用
- 移除不必要的 jacoco 代码覆盖率插件
- 简化 Gradle 任务配置

#### 1.3 简化 build.gradle.kts 文件
- 移除复杂的测试配置
- 移除冗余的构建类型配置
- 简化 Android 配置项

### 2. 减少抽象层次

#### 2.1 合并管理类
- 将 `DLNACastManagerImpl` 合并到 `DLNACastManager` 中
- 简化 `DlnaManager` 类，减少不必要的委托
- 移除 `DefaultRegistry` 与 `RegistryImpl` 的多层委托结构

#### 2.2 简化工厂模式
- 减少工厂类的使用，采用更直接的实例创建方式
- 移除过度的依赖注入模式

#### 2.3 精简接口定义
- 减少接口层级，合并功能相似的接口
- 避免仅为抽象而创建的接口

### 3. 简化错误处理机制

#### 3.1 统一错误类型
- 合并 `DLNAErrorType` 和内部错误类型
- 减少错误类型的数量，只保留核心错误类型

#### 3.2 简化异常处理
- 直接使用具体异常类型，减少异常转换层
- 减少嵌套的 try-catch 块

### 4. 测试框架统一

#### 4.1 选择单一测试框架
- 推荐使用 JUnit 4 或 JUnit 5（选一个）
- 移除 Kotest 和冗余的测试依赖

#### 4.2 简化测试配置
- 移除复杂的测试任务配置
- 使用更简单的测试设置

### 5. 简化 API 设计

#### 5.1 减少数据转换
- 移除 `RemoteDevice` 与内部设备类型之间不必要的转换
- 直接暴露必要的数据结构

#### 5.2 直接的方法调用
- 减少方法调用链的长度
- 移除不必要的代理方法

### 6. 移除冗余代码

#### 6.1 简化单例模式
- 使用更简单的单例实现
- 如果不需要 Java 兼容性，移除 `@JvmStatic` 等注解

#### 6.2 简化重试机制
- 移除复杂的重试逻辑，或使用更简单的实现

#### 6.3 移除不必要的映射
- 移除错误类型映射表等冗余代码

## 实施步骤

### 第一阶段：构建系统简化
1. 简化 build.gradle.kts 文件
2. 移除 Version Catalog，直接管理依赖
3. 移除 jacoco 配置

### 第二阶段：代码结构优化
1. 合并 `DLNACastManager` 和 `DLNACastManagerImpl`
2. 简化错误处理机制
3. 精简接口层级

### 第三阶段：移除冗余代码
1. 移除不必要的数据转换层
2. 简化单例模式
3. 整理和清理未使用的代码

### 第四阶段：测试框架统一
1. 选择单一测试框架
2. 移除冗余测试依赖
3. 简化测试配置

## 预期收益

1. **更好的可维护性**：减少代码复杂度，使新开发者更容易理解
2. **更快的编译速度**：减少构建配置和依赖
3. **更小的二进制文件大小**：移除冗余代码和不必要的依赖
4. **更简单的API**：为使用者提供更直观的接口
5. **更高的开发效率**：减少开发者需要理解的抽象层级

## 具体文件修改建议

下面列出主要需要修改的文件及修改建议：

1. `settings.gradle.kts`：简化仓库配置
2. `app/build.gradle.kts`：移除 jacoco 配置，简化构建类型
3. `DLNACastManager.kt`：合并 `DLNACastManagerImpl` 功能
4. `DLNAErrorType.kt`：简化错误类型
5. `RemoteDevice.kt`：减少不必要的转换 