# UPnPCast库异常场景测试用例

## 测试环境
- 测试设备：主流版本 Android 9.0，最新版本 Android 13
- 测试网络：可控Wi-Fi环境，支持模拟网络中断和弱信号
- 测试DLNA设备：至少包含三种不同厂商的设备（如小米电视、三星电视、LG电视等）

## 1. 网络中断恢复测试

### 测试用例 1.1：搜索过程中网络中断
1. **前置条件**：手机与DLNA设备连接在同一Wi-Fi网络
2. **操作步骤**：
   - 启动设备搜索
   - 在搜索过程中断开Wi-Fi连接（或开启飞行模式）
   - 等待5秒
   - 重新启用Wi-Fi连接
   - 等待20秒
3. **预期结果**：
   - 网络中断时收到适当的错误回调
   - 网络恢复后，应用能自动恢复设备搜索或提示用户重新搜索
   - 无崩溃或ANR现象

### 测试用例 1.2：设备连接中网络中断
1. **前置条件**：已发现DLNA设备但尚未连接
2. **操作步骤**：
   - 开始连接设备
   - 连接过程中断开Wi-Fi
   - 等待连接超时
   - 重新连接Wi-Fi
   - 再次尝试连接设备
3. **预期结果**：
   - 首次连接失败时返回明确的错误信息
   - 应用状态正确恢复到"未连接"
   - 再次连接能够成功

### 测试用例 1.3：播放过程中网络中断
1. **前置条件**：正在播放媒体
2. **操作步骤**：
   - 在媒体播放过程中断开Wi-Fi
   - 等待10秒
   - 恢复Wi-Fi连接
3. **预期结果**：
   - 播放状态正确更新（如PAUSED或ERROR）
   - 网络恢复后能够继续播放或提示用户恢复播放
   - 错误处理机制正常工作

## 2. 设备响应超时测试

### 测试用例 2.1：设备超时响应
1. **前置条件**：使用网络代理工具模拟设备响应延迟
2. **操作步骤**：
   - 设置代理延迟响应时间为3秒
   - 启动设备搜索
   - 尝试连接设备
3. **预期结果**：
   - 搜索过程正常完成，可能耗时更长
   - 连接过程正常完成，不会因为延迟而失败
   - 适当的超时处理机制生效

### 测试用例 2.2：设备无响应
1. **前置条件**：存在可连接的DLNA设备
2. **操作步骤**：
   - 连接设备
   - 使用网络工具阻止设备HTTP响应
   - 发送播放命令
   - 等待命令超时
3. **预期结果**：
   - 命令超时后不会无限等待
   - 返回合适的错误信息
   - 应用状态正确维护，不会卡死

### 测试用例 2.3：SOAP错误响应
1. **前置条件**：已连接DLNA设备
2. **操作步骤**：
   - 使用代理工具修改SOAP响应，注入错误代码
   - 发送播放命令
3. **预期结果**：
   - 正确解析错误代码并返回友好错误信息
   - 不会导致应用崩溃
   - 异常处理机制正常工作

## 3. 内存压力测试

### 测试用例 3.1：低内存环境测试
1. **前置条件**：使用开发者选项模拟低内存环境，或使用内存压力工具
2. **操作步骤**：
   - 激活低内存环境（如运行多个大型应用）
   - 启动设备搜索
   - 反复连接和断开设备10次
3. **预期结果**：
   - 缓存自动调整适应低内存状态
   - 不出现OOM错误
   - 关键功能正常运行，即使低内存

### 测试用例 3.2：高频缓存访问
1. **前置条件**：已缓存多个设备信息
2. **操作步骤**：
   - 在短时间内快速获取缓存中的设备信息（循环1000次）
   - 同时启动设备搜索
3. **预期结果**：
   - 缓存命中率维持在高水平
   - 内存使用量稳定
   - 无性能明显下降

### 测试用例 3.3：内存回收恢复
1. **前置条件**：正在播放媒体并缓存了设备信息
2. **操作步骤**：
   - 触发系统GC（如切换到其他内存密集型应用）
   - 返回应用继续播放
3. **预期结果**：
   - 应用正确恢复状态
   - 播放继续，不需要重新连接
   - 关键缓存不被不当回收

## 4. 极端条件测试

### 测试用例 4.1：大量设备环境
1. **前置条件**：使用模拟器或多设备环境，创建20+个DLNA设备
2. **操作步骤**：
   - 启动设备搜索
   - 等待所有设备被发现
3. **预期结果**：
   - 所有设备都被正确发现
   - UI响应保持流畅
   - 内存使用量在合理范围内

### 测试用例 4.2：恶劣网络条件
1. **前置条件**：使用网络工具模拟高延迟、高丢包率网络
2. **操作步骤**：
   - 设置网络延迟为300ms，丢包率15%
   - 尝试设备搜索和连接
   - 尝试播放媒体
3. **预期结果**：
   - 能够最终完成搜索和连接
   - 播放可能间断但不会崩溃
   - 错误处理和重试机制正常工作

### 测试用例 4.3：前后台切换
1. **前置条件**：正在播放媒体
2. **操作步骤**：
   - 将应用切换到后台
   - 打开多个其他应用占用内存
   - 等待5分钟
   - 返回应用
3. **预期结果**：
   - 应用状态正确恢复
   - 播放可以继续或恢复
   - 不出现状态混乱或内存泄漏

## 测试执行和监控

在执行以上异常场景测试时，应同时监控以下指标：

1. **内存使用**：使用Android Profiler跟踪内存使用曲线
2. **CPU使用率**：确保在异常情况下CPU使用不会飙升
3. **崩溃和ANR**：记录所有崩溃和ANR事件
4. **网络流量**：监控网络请求数量和流量使用

## 测试结果记录

每个测试用例执行后，记录以下信息：

1. 测试环境详细配置
2. 测试过程中观察到的行为
3. 系统资源使用情况
4. 异常或错误的详细记录
5. 需要改进的地方 